extends layout

block content
  input#nl.form-control(type='hidden', name='note_list', value=(note_list))
  input#sl.form-control(type='hidden', name='subject_list', value=(subject_list))
  input#tl.form-control(type='hidden', name='topic_list', value=(topic_list))
  div(class="border-bottom border-secondary")
    div(class="row gx-0")
      div(class="col-sm-12")
        <p>
        | You have !{note_count} notes 
        if subject_name
          | under !{subject_name}
        if topic_name 
          | -&gt;!{topic_name}
        if subtopic_name 
          | -&gt;!{subtopic_name}
        </p>
  div(class="border-bottom border-secondary")
    div(class="row gx-0" id='list_div')
      div(class="col-sm-2")
        a(class='text' href='#subject' onClick="redraw_page(this);") Subject
      div(class="col-sm-3")
        a(class='text' href='#topic' onClick="redraw_page(this);") Topic
      div(class="col-sm-3")
        a(class='text' href='#title' onClick="redraw_page(this);") Title
      div(class="col-sm-2")
        a(class='text' href='#creationDate' onClick="redraw_page(this);") Creation date
      div(class="col-sm-2")
        a(class='text' href='#updateDate' onClick="redraw_page(this);") Update date
      script(type="text/javascript").
        let ld = document.getElementById('list_div'); // div element to which all dynamically sorted elements will be added
        let nl = document.getElementById('nl'); // note_list hidden element
        let sl = document.getElementById('sl'); // subject_list hidden element
        let tl = document.getElementById('tl'); // topic_list hidden element
        let nl_val = JSON.parse(nl.value);      // parse json in mongodb generated note_list to get array of key value pairs
        let sl_val = JSON.parse(sl.value);      // parse json in mongodb generated subject_list to get array of key value pairs
        let tl_val = JSON.parse(tl.value);      // parse json in mongodb generated topic_list to get array of key value pairs
        
        let rows = [];                          // generate a row for each note with subject and topic titles populated for sorting
        let subject, topic, title, url, created, updated;
        for (let nl_row of Object.values(nl_val)) {
          for (let sl_row of Object.values(sl_val)) { 
            if (sl_row._id === nl_row.subject_id) {
              subject = sl_row.title;
            }
          }
          for (let tl_row of Object.values(tl_val)) { 
            if (tl_row._id === nl_row.topic_id) {
              topic = tl_row.title;
            }
          }
          url = nl_row.update_url;
          title = nl_row.title;
          created = nl_row.creationDate_formatted;
          updated = nl_row.updateDate_formatted;
          rows.push({'subject':subject,'topic':topic,'url':url,'title':title,'creationDate':created,'updateDate':updated});
        }

        // get column title from text after # in url
        let hash = location.hash.substr(1);
        if (hash == "") {
          hash = "title";
        }
        // sort note list based on column title
        rows.sort(compareValues(hash, 'desc'));
        
        // render sorted list to page
        for (let row of Object.values(rows)) {
          addNoteElement(2, row.subject);
          addNoteElement(3, row.topic);
          addNoteElement(3, row.title, row.url);
          addNoteElement(2, row.creationDate);
          addNoteElement(2, row.updateDate);
        }
        // add element to list div
        function addNoteElement(width, text, url) {
          let newDiv = document.createElement("div");
          newDiv.classList.add('col-sm-' + width);
          let newElement;
          if (url) {
            newElement = document.createElement('a');
            newElement.href  = url;
            newElement.textContent = text;
          } else {
            newElement = document.createElement("p");
            let newElement2 = document.createTextNode(text);
            newElement.appendChild(newElement2);
          }
          newDiv.appendChild(newElement);
          ld.appendChild(newDiv);
        }
        // redraw page with selected column title (after #) for sorting
        function redraw_page(url) {
          window.location.replace(url);
          window.location.reload();
        }
        // compare function used by sort
        function compareValues(key, order = 'asc') {
          return function innerSort(a, b) {
            if (!a.hasOwnProperty(key) || !b.hasOwnProperty(key)) {
              // property doesn't exist on either object
              return 0;
            }

            let varA, varB;

            if ((key == 'creationDate') || (key == 'updateDate')) {
              // parse dates to get seconds from unix time 0
              varA = Date.parse(a[key]);
              varB = Date.parse(b[key]);
            } else {
              // assume text if not date
              varA = (typeof a[key] === 'string')
                ? a[key].toUpperCase() : a[key];
              varB = (typeof b[key] === 'string')
                ? b[key].toUpperCase() : b[key];
            }

            let comparison = 0;
            if (varA > varB) {
              comparison = 1;
            } else if (varA < varB) {
              comparison = -1;
            }
            return (
              (order === 'desc') ? (comparison * -1) : comparison
            );
          }
        }